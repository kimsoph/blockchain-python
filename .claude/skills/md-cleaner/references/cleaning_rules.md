# Markdown Cleaning Rules Reference

마크다운 클리닝 시 적용되는 상세 규칙 및 패턴을 정리한 참조 문서입니다.

**버전**: v3.1 (2026-01-06)

## 0. v3.1 신규 규칙

### HTML 엔티티 디코딩

PDF/OCR 변환 시 남아있는 HTML 엔티티를 자동으로 처리:

| HTML 엔티티 | 변환 결과 | 비고 |
|-------------|-----------|------|
| `&nbsp;` | `\xa0` → ` ` | Non-breaking space, 이후 일반 공백으로 정규화 |
| `&lt;` | `<` | |
| `&gt;` | `>` | |
| `&amp;` | `&` | |
| `&quot;` | `"` | |
| `&#NNN;` | 해당 문자 | 숫자 엔티티 |
| `&#xHHHH;` | 해당 문자 | 16진수 엔티티 |

**처리 시점**: 제어문자/유니코드 정리 직후

### 마크다운 링크/이미지 보호

링크 `[text](url)`와 이미지 `![alt](url)` 내부는 클리닝에서 제외:

```
# 보호되는 부분
[**볼드 텍스트**](https://example.com)  → 내부 **볼드 텍스트** 보존
![이미지  공백](path/image.png)          → 내부 공백 보존

# 보호 범위
- 대괄호 내부 텍스트 전체
- URL 부분 전체
```

**처리 방식**: 플레이스홀더 치환 → 클리닝 → 복원

### 테이블 열 정렬 (옵션)

`--align-tables` 옵션 사용 시 테이블 열 너비를 정렬:

**너비 계산 규칙**:
- ASCII 문자: 1칸
- 한글 (`\uac00`-`\ud7a3`): 2칸
- 한자 (`\u4e00`-`\u9fff`): 2칸
- 히라가나/가타카나 (`\u3040`-`\u30ff`): 2칸

### 커스텀 제거 패턴 (옵션)

`--extra-pattern` 옵션으로 추가 제거 규칙 지정:

```bash
# 정규식 사용
--extra-pattern "^\s*\[제거\]\s*$"

# 여러 패턴
--extra-pattern "^==+$" --extra-pattern "^--+$"
```

**적용 시점**: 기본 페이지 번호 감지 후 추가 체크

### 페이지 번호 범위 설정 (옵션)

`--page-max N` 옵션으로 단독 숫자 감지 범위 조정:

```bash
# 기본값 (100 이하)
50    → 제거
101   → 보존

# --page-max 50 설정 시
50    → 제거
51    → 보존
```

## 1. 페이지 번호 제거 규칙

### 감지 패턴

다음 패턴들을 페이지 번호로 감지하여 제거:

| 패턴 | 정규식 | 예시 |
|------|--------|------|
| 한글 페이지 | `^\s*페이지\s*\d+\s*$` | "페이지 1", "  페이지 25  " |
| 영문 페이지 | `^\s*Page\s*\d+\s*$` | "Page 1", "  Page 42  " |
| 슬래시 구분 | `^\s*\d+\s*/\s*\d+\s*$` | "1 / 10", "5/20" |
| 대괄호 | `^\s*\[\s*\d+\s*\]\s*$` | "[1]", "  [25]  " |
| 하이픈 구분 | `^\s*-\s*\d+\s*-\s*$` | "- 1 -", "  - 15 -  " |
| 단독 숫자 | `^\s*\d+\s*$` | "1", "42" (100 이하만) |

### 보존 조건

다음 경우에는 페이지 번호로 간주하지 않고 보존:

- **마크다운 문법 포함 라인**: 헤더, 리스트, 인용구 등
- **100 초과 숫자**: 단독 숫자가 100을 초과하면 페이지 번호가 아닌 것으로 간주
- **빈 라인**: 빈 라인은 검사 대상에서 제외

### 예시

**제거됨:**
```
페이지 5

1 / 20

[3]

- 7 -

42
```

**보존됨:**
```
# 1. 서론

- 1번 항목

> 페이지 참조

150

2024
```

## 2. 공백 및 줄바꿈 정리

### 과도한 빈 줄 제거

**규칙**: 3개 이상의 연속된 빈 줄을 2개로 정리

**이유**: 마크다운에서 2개의 빈 줄이면 충분한 구분 효과

**변환 예시:**
```
# 제목




본문
```
↓
```
# 제목


본문
```

### 줄 끝 공백 제거

**규칙**: 각 줄의 끝 공백 제거 (단, 마크다운 줄바꿈용 2개 스페이스는 보존)

**마크다운 줄바꿈**: 줄 끝에 2개 스페이스 = 강제 줄바꿈

**변환 예시:**
```
텍스트
다음 줄
또 다음 줄
```
↓
```
텍스트
다음 줄
또 다음 줄
```
(2번째 줄만 줄바꿈 보존)

### 연속 스페이스 정리

**규칙**: 연속된 스페이스를 하나로 정리 (코드 블록 제외)

**변환 예시:**
```
일반    텍스트에서는     정리됨
```
↓
```
일반 텍스트에서는 정리됨
```

**보존 예시:**
```python
def function():
    return "코드 블록 내부 공백 보존"
```

## 3. 특수문자 및 유니코드 처리

### 제어 문자 제거

**제거 대상**: ASCII 제어 문자 (0x00-0x1F, 0x7F)

**보존**: 줄바꿈(\n), 캐리지 리턴(\r), 탭(\t)

**제거되는 문자들:**
- NULL (0x00)
- Bell (0x07)
- Backspace (0x08)
- Form Feed (0x0C)
- 기타 제어 문자

### Zero-Width 문자 제거

**제거 대상**:
- Zero Width Space (U+200B)
- Zero Width Non-Joiner (U+200C)
- Zero Width Joiner (U+200D)
- Left-to-Right Mark (U+200E)
- Right-to-Left Mark (U+200F)
- Byte Order Mark (U+FEFF)

**이유**: 보이지 않는 문자로 인한 의도치 않은 동작 방지

### 유니코드 공백 정규화

**정규화 대상** (모두 일반 스페이스로 변환):
- Non-Breaking Space (U+00A0)
- Em Space (U+2003)
- En Space (U+2002)
- Ideographic Space (U+3000)
- 기타 특수 공백 문자

**변환 예시:**
```
텍스트　사이　공백
```
↓
```
텍스트 사이 공백
```

## 4. 마크다운 문법 보존

### 보존 대상 패턴

클리닝 중 절대 제거되지 않는 마크다운 문법 요소:

| 요소 | 패턴 | 예시 |
|------|------|------|
| 헤더 | `^#{1,6}\s` | `# 제목`, `## 소제목` |
| 비순서 리스트 | `^\s*[-*+]\s` | `- 항목`, `* 항목` |
| 순서 리스트 | `^\s*\d+\.\s` | `1. 첫째`, `2. 둘째` |
| 인용구 | `^\s*>\s` | `> 인용문` |
| 코드 블록 | `^\s*```  ` | ` ```python` |
| 테이블 | `^\s*\|` | `| 열1 | 열2 |` |
| 수평선 | `^\s*---\s*$` | `---` |

### 코드 블록 특별 처리

**규칙**: 코드 블록 내부는 모든 클리닝 규칙에서 제외

**감지 방법**: ` ``` ` 태그로 감싸인 영역

**보존 항목**:
- 모든 공백 및 들여쓰기
- 연속된 빈 줄
- 모든 특수문자

**예시:**
````
```python
def    function():
    # 코드    내부    모든    공백    보존


    return    "값"
```
````
→ 그대로 유지

### 인라인 코드 블록

**규칙**: 백틱(`)으로 감싸인 인라인 코드도 보존

**예시:**
```
`code   with    spaces` 는 그대로 유지
```

## 5. 한글 처리 규칙

### 인코딩

**기본 인코딩**: UTF-8

**읽기 전략**:
1. UTF-8로 읽기 시도
2. 실패 시 chardet으로 자동 감지
3. 감지된 인코딩으로 읽기
4. 항상 UTF-8로 저장

### 한글 페이지 번호

**감지 패턴**:
- "페이지 1", "페이지 10" 등
- "쪽 1", "쪽 25" (일부 문서)

### 한글 공백

**규칙**: 한글과 영문 사이 공백은 유지

**보존 예시:**
```
한글과 English 사이 공백
```

## 6. 실제 적용 예시

### PDF 변환 마크다운 클리닝

**변환 전:**
```
# 문서 제목

페이지 1

이것은    첫 번째    문단입니다.



1 / 10

두 번째    문단입니다.




페이지 2
```

**변환 후:**
```
# 문서 제목

이것은 첫 번째 문단입니다.


두 번째 문단입니다.
```

### OCR 마크다운 클리닝

**변환 전:**
```
인 식   오 류   가   있 는   텍 스 트



-   3   -

정상    텍스트　　특수공백
```

**변환 후:**
```
인 식 오 류 가 있 는 텍 스 트


정상 텍스트 특수공백
```

### 웹 스크래핑 마크다운 클리닝

**변환 전:**
```
제목​​​(zero-width 포함)



[1]

내용 　이상한　공백



2 / 5
```

**변환 후:**
```
제목


내용 이상한 공백
```

## 7. 고급 규칙

### 테이블 처리

**규칙**: 테이블 구조는 절대 변경하지 않음

**보존 항목**:
- 파이프 구분자 정렬
- 헤더 구분선
- 셀 내부 공백

**예시:**
```
| 헤더1    | 헤더2     |
|----------|-----------|
| 값1      | 값2       |
```
→ 그대로 유지

### 리스트 중첩

**규칙**: 들여쓰기 기반 리스트 중첩 보존

**예시:**
```
- 항목 1
  - 하위 항목 1
  - 하위 항목 2
- 항목 2
```
→ 들여쓰기 보존

### 링크 및 이미지

**규칙**: 마크다운 링크/이미지 문법 완전 보존

**예시:**
```
[링크 텍스트](https://example.com)
![이미지](image.png)
```
→ 그대로 유지

## 8. 제한사항 및 주의사항

### 알려진 제한사항

1. **페이지 번호 오감지**: 100 이하 단독 숫자는 의도적이어도 제거될 수 있음
2. **변형 문법**: GitHub Flavored Markdown 외 변형 문법은 고려 안 됨
3. **복잡한 테이블**: 매우 복잡한 테이블 구조는 일부 공백 정리될 수 있음

### 권장 사항

1. **원본 백업**: 클리닝 전 원본 파일 백업 권장
2. **검토**: 클리닝 후 결과 검토 (특히 중요 문서)
3. **단계별 적용**: 대량 파일은 샘플 테스트 후 적용

### 복구 방법

원본 파일은 절대 수정되지 않으므로:
- 클리닝 결과가 만족스럽지 않으면 `*_clean.md` 삭제
- 원본 파일은 그대로 유지됨
